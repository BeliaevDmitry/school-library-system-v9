<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"/><title>Остатки</title><link rel="stylesheet" th:href="@{/css/app.css}"></head>
<body>
<div class="container">
  <div class="top-back"><a th:href="@{/librarian/dashboard}">← Назад</a></div>
  <h2 th:text="'Остатки — ' + ${building.name}"></h2>

  <div class="card" th:if="${error}">
    <h3 style="margin-top:0">Ошибка</h3>
    <pre th:text="${error}"></pre>
  </div>
  <div class="card" th:if="${success}">
    <h3 style="margin-top:0">Готово</h3>
    <p th:text="${success}"></p>
  </div>

  <p class="muted">
    Поля <b>Выдано</b>, <b>В кабинетах</b> и <b>Примечание</b> заполняются библиотекарем для инвентаризации.
    Проверка доступна на странице <a th:href="@{/librarian/inventory}">Инвентаризация</a>.
  </p>

  <div class="card">
    <h3>Загрузка остатков из Excel</h3>
    <p class="muted">Шаблон на русском: <a th:href="@{/librarian/templates/stock.xlsx}">скачать</a></p>
    <form method="post" th:action="@{/librarian/import/stock}" enctype="multipart/form-data">
      <input type="file" name="file" accept=".xlsx" required/>
      <button type="submit">Загрузить файл</button>
    </form>
  </div>

  <div class="card">
    <h3>Добавить книгу вручную</h3>
    <p class="muted">Совет: если ввести <b>Всего</b> и <b>Свободно</b>, нажмите «Рассчитать в использовании».</p>
    <form method="post" th:action="@{/librarian/stocks/add}" class="form-grid">
      <label>Предмет</label><input name="subject" placeholder="Например: Математика" required/>
      <label>Параллель</label><input type="number" name="grade" min="1" max="11" required/>
      <label>Название</label><input name="title" placeholder="Название учебника" required/>
      <label>Авторы</label><input name="authors"/>
      <label>Издательство</label><input name="publisher"/>
      <label>Год издания</label><input type="number" name="year" min="1900" max="2100"/>
      <label>ISBN</label><input name="isbn"/>
      <label>Всего</label><input type="number" id="addTotal" name="total" min="0" value="0"/>
      <label>Свободно</label><input type="number" id="addAvailable" name="available" min="0" value="0"/>
      <label>В использовании</label><input type="number" id="addInUse" name="inUse" min="0" value="0"/>
      <button type="button" class="full" id="calcInUseBtn">Рассчитать в использовании</button>
      <button type="submit" class="full">Добавить / обновить</button>
    </form>
  </div>

  <div class="card">
    <h3>Быстрый поиск по остаткам</h3>
    <input id="stockFilter" type="text" placeholder="Введите предмет, параллель или название книги"/>
    <p class="muted" id="stockFilterCount"></p>
  </div>

  <table>
    <thead>
    <tr>
      <th>Предмет</th><th>Параллель</th><th>Учебник</th>
      <th>Всего</th><th>Доступно</th><th>В использовании</th>
      <th>Выдано</th><th>В кабинетах</th><th>Примечание</th><th></th>
    </tr>
    </thead>
    <tbody>
      <tr th:each="s : ${stocks}" class="stock-row"
          th:attr="data-search=${(s.bookTitle.subject.name + ' ' + s.bookTitle.grade + ' ' + s.bookTitle.title).toLowerCase()}">
        <td th:text="${s.bookTitle.subject.name}"></td>
        <td th:text="${s.bookTitle.grade}"></td>
        <td th:text="${s.bookTitle.title}"></td>
        <td th:text="${s.total}"></td>
        <td th:text="${s.available}"></td>
        <td th:text="${s.inUse}"></td>
        <td colspan="4">
          <form th:action="@{'/librarian/stocks/' + ${s.id} + '/extra'}" method="post" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <label class="muted">Выдано</label>
            <input type="number" name="issuedToStudents" min="0" style="width:90px" th:value="${s.issuedToStudents}"/>
            <label class="muted">В кабинетах</label>
            <input type="number" name="inCabinets" min="0" style="width:90px" th:value="${s.inCabinets}"/>
            <label class="muted">Примечание</label>
            <input type="text" name="note" style="min-width:240px" th:value="${s.note}"/>
            <button type="submit">Сохранить</button>
          </form>
        </td>
      </tr>
    </tbody>
  </table>

  <p><a th:href="@{/librarian/dashboard}">← Назад</a></p>
</div>
<script>
  (function () {
    const filter = document.getElementById('stockFilter');
    const rows = Array.from(document.querySelectorAll('.stock-row'));
    const count = document.getElementById('stockFilterCount');

    function refreshCounter() {
      const visible = rows.filter(r => r.style.display !== 'none').length;
      count.textContent = 'Показано строк: ' + visible + ' из ' + rows.length;
    }

    if (filter) {
      filter.addEventListener('input', function () {
        const q = (this.value || '').trim().toLowerCase();
        rows.forEach(r => {
          const hay = r.getAttribute('data-search') || '';
          r.style.display = !q || hay.includes(q) ? '' : 'none';
        });
        refreshCounter();
      });
      refreshCounter();
    }

    const total = document.getElementById('addTotal');
    const available = document.getElementById('addAvailable');
    const inUse = document.getElementById('addInUse');
    const btn = document.getElementById('calcInUseBtn');
    if (btn && total && available && inUse) {
      btn.addEventListener('click', function () {
        const t = parseInt(total.value || '0', 10);
        const a = parseInt(available.value || '0', 10);
        inUse.value = Math.max(0, t - a);
      });
    }
  })();
</script>
</body>
</html>
